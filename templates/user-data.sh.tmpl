readonly CONFIG_DIR=/opt/snowplow/config

sudo mkdir -p $${CONFIG_DIR}
sudo base64 --decode << EOF > $${CONFIG_DIR}/iglu-server.hocon
${config_b64}
EOF

# Run the server setup
set +e
sudo docker run \
  --name iglu-server-setup \
  --network host \
  --mount type=bind,source=$${CONFIG_DIR},target=/snowplow/config \
  -e 'JDK_JAVA_OPTIONS=${java_opts}' \
  snowplow/iglu-server:${version} \
  setup --config /snowplow/config/iglu-server.hocon
set -e

# Launch the server
sudo docker run \
  -d \
  --name iglu-server \
  --restart always \
  --network host \
  --memory=$(get_application_memory_mb)m \
  --log-opt max-size=10m \
  --log-opt max-file=5 \
  --mount type=bind,source=$${CONFIG_DIR},target=/snowplow/config \
  -p ${port}:${port} \
  -e 'JDK_JAVA_OPTIONS=${java_opts}' \
  snowplow/iglu-server:${version} \
  --config /snowplow/config/iglu-server.hocon

${telemetry_script}
